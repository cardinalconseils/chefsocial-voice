name: Deploy Integrated App with Admin Panel

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-integrated:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“‹ Log deployment info
        run: |
          echo "ğŸ” Integrated App Deployment (Main + Admin)"
          echo "==========================================="
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo ""
          echo "ğŸ“ Project structure:"
          ls -la
          echo ""
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸ“¦ Install main app dependencies
        run: |
          echo "ğŸ“¦ Installing main app dependencies..."
          npm install
          echo "âœ… Main app dependencies installed"
      
      - name: ğŸ“¦ Install admin panel dependencies
        working-directory: ./admin-panel
        run: |
          echo "ğŸ“¦ Installing admin panel dependencies..."
          npm install
          echo "âœ… Admin panel dependencies installed"
      
      - name: ğŸ—ï¸ Build and integrate admin panel
        run: |
          echo "ğŸ—ï¸ Building admin panel and integrating with main app..."
          ./deploy-admin.sh
          echo "âœ… Admin panel integrated at /admin"
          echo "ğŸ“ Verification:"
          ls -la public/admin/ || echo "âŒ Admin integration failed"
      
      - name: ğŸ” Verify Vercel secrets
        run: |
          echo "ğŸ” Verifying Vercel secrets..."
          echo "VERCEL_TOKEN exists: ${{ secrets.VERCEL_TOKEN != '' }}"
          echo "VERCEL_ORG_ID exists: ${{ secrets.VERCEL_ORG_ID != '' }}"
          echo "VERCEL_PROJECT_ID exists: ${{ secrets.VERCEL_PROJECT_ID != '' }}"
          
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "âŒ VERCEL_TOKEN is missing"
            echo "Please add VERCEL_TOKEN to repository secrets"
            exit 1
          fi
          
          if [ -z "${{ secrets.VERCEL_ORG_ID }}" ]; then
            echo "âŒ VERCEL_ORG_ID is missing"
            echo "Please add VERCEL_ORG_ID to repository secrets"
            exit 1
          fi
          
          if [ -z "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
            echo "âŒ VERCEL_PROJECT_ID is missing"
            echo "Please add VERCEL_PROJECT_ID to repository secrets"
            exit 1
          fi
          
          echo "âœ… All required secrets are present"
      
      - name: ğŸš€ Deploy integrated app to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "ğŸš€ Deploying integrated app to Vercel..."
          npx vercel --version
          npx vercel pull --yes --environment=production --token=$VERCEL_TOKEN
          npx vercel build --prod --token=$VERCEL_TOKEN
          npx vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
      
      - name: âœ… Deployment complete
        run: |
          echo "ğŸ‰ Integrated app deployment completed!"
          echo "ğŸŒ Main app: Available at your Vercel domain"
          echo "ğŸ”§ Admin panel: Available at /admin"
          echo ""
          echo "ğŸ“‹ Next steps:"
          echo "1. Test main app functionality"
          echo "2. Test admin panel at /admin"
          echo "3. Verify API connectivity"
          echo "4. Configure custom domain if needed"