<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - ChefSocial Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Source+Sans+Pro:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../shared/styles.css">
</head>
<body>
    <div class="dashboard-container">
        <div id="dashboard-sidebar"></div>

        <div class="main-content">
            <div class="header">
                <div>
                    <h1 class="header-title">Profile Management</h1>
                    <div id="breadcrumbs" class="breadcrumbs"></div>
                </div>
            </div>

            <div class="grid grid-2">
                <!-- Personal Information -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Personal Information</h3>
                        <p class="card-description">Update your personal details</p>
                    </div>
                    
                    <form id="personal-info-form">
                        <div class="form-group">
                            <label class="form-label" for="name">Full Name</label>
                            <input type="text" id="name" class="form-input" placeholder="Enter your name">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="email">Email Address</label>
                            <input type="email" id="email" class="form-input" placeholder="Enter your email" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="phone">Phone Number</label>
                            <input type="tel" id="phone" class="form-input" placeholder="Enter your phone">
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Update Personal Info</button>
                    </form>
                </div>

                <!-- Restaurant Information -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Restaurant Information</h3>
                        <p class="card-description">Details about your restaurant</p>
                    </div>
                    
                    <form id="restaurant-info-form">
                        <div class="form-group">
                            <label class="form-label" for="restaurant-name">Restaurant Name</label>
                            <input type="text" id="restaurant-name" class="form-input" placeholder="Enter restaurant name">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="cuisine-type">Cuisine Type</label>
                            <input type="text" id="cuisine-type" class="form-input" placeholder="e.g., Italian, French, Asian">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="location">Location</label>
                            <input type="text" id="location" class="form-input" placeholder="City, State/Province">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="description">Description</label>
                            <textarea id="description" class="form-input" rows="3" placeholder="Brief description of your restaurant"></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Update Restaurant Info</button>
                    </form>
                </div>

                <!-- Brand Voice Settings -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Brand Voice Settings</h3>
                        <p class="card-description">Customize how AI represents your brand</p>
                    </div>
                    
                    <form id="brand-voice-form">
                        <div class="form-group">
                            <label class="form-label" for="brand-personality">Brand Personality</label>
                            <select id="brand-personality" class="form-input">
                                <option value="">Select personality...</option>
                                <option value="friendly">Friendly & Approachable</option>
                                <option value="professional">Professional & Sophisticated</option>
                                <option value="casual">Casual & Fun</option>
                                <option value="elegant">Elegant & Refined</option>
                                <option value="bold">Bold & Adventurous</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="content-tone">Content Tone</label>
                            <select id="content-tone" class="form-input">
                                <option value="">Select tone...</option>
                                <option value="conversational">Conversational</option>
                                <option value="informative">Informative</option>
                                <option value="inspiring">Inspiring</option>
                                <option value="playful">Playful</option>
                                <option value="authoritative">Authoritative</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="specialties">Specialties</label>
                            <input type="text" id="specialties" class="form-input" placeholder="e.g., Fresh pasta, Wood-fired pizza">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="target-audience">Target Audience</label>
                            <input type="text" id="target-audience" class="form-input" placeholder="e.g., Food enthusiasts, Families">
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Update Brand Voice</button>
                    </form>
                </div>

                <!-- Account Settings -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Account Settings</h3>
                        <p class="card-description">Manage your account preferences</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="language">Preferred Language</label>
                        <select id="language" class="form-input">
                            <option value="en">English</option>
                            <option value="fr">Fran√ßais</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <h4 style="margin-bottom: 0.5rem;">Quick Actions</h4>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <a href="billing.html" class="btn btn-secondary">Manage Billing</a>
                            <button id="change-password-btn" class="btn btn-secondary">Change Password</button>
                            <button id="export-data-btn" class="btn btn-secondary">Export Data</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Success/Error Messages -->
            <div id="message-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>
        </div>
    </div>

    <script src="../shared/auth.js"></script>
    <script src="../shared/nav.js"></script>
    <script>
        class ProfileManager {
            constructor() {
                this.authManager = new AuthManager();
                this.nav = new DashboardNav();
                
                this.init();
            }

            async init() {
                // Check authentication
                const isAuthenticated = await this.authManager.verifyAuth();
                if (!isAuthenticated) return;

                // Render navigation
                this.nav.renderSidebar();
                this.nav.renderBreadcrumbs();

                // Load profile data
                this.loadProfileData();
                this.setupEventListeners();
            }

            async loadProfileData() {
                try {
                    const response = await this.authManager.apiRequest('/api/user/profile');
                    if (!response.ok) throw new Error('Failed to load profile');

                    const profile = await response.json();
                    this.populateForm(profile);

                } catch (error) {
                    console.error('Failed to load profile:', error);
                    this.showMessage('Failed to load profile data', 'error');
                }
            }

            populateForm(profile) {
                // Personal information
                document.getElementById('name').value = profile.name || '';
                document.getElementById('email').value = profile.email || '';
                document.getElementById('phone').value = profile.phone || '';

                // Restaurant information
                document.getElementById('restaurant-name').value = profile.restaurant_name || '';
                document.getElementById('cuisine-type').value = profile.cuisine_type || '';
                document.getElementById('location').value = profile.location || '';
                document.getElementById('description').value = profile.description || '';

                // Brand voice settings
                document.getElementById('brand-personality').value = profile.brand_personality || '';
                document.getElementById('content-tone').value = profile.content_tone || '';
                document.getElementById('specialties').value = profile.specialties || '';
                document.getElementById('target-audience').value = profile.target_audience || '';

                // Account settings
                document.getElementById('language').value = profile.preferred_language || 'en';
            }

            setupEventListeners() {
                // Personal info form
                document.getElementById('personal-info-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.updatePersonalInfo();
                });

                // Restaurant info form
                document.getElementById('restaurant-info-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.updateRestaurantInfo();
                });

                // Brand voice form
                document.getElementById('brand-voice-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.updateBrandVoice();
                });

                // Language change
                document.getElementById('language').addEventListener('change', (e) => {
                    this.updateLanguage(e.target.value);
                });

                // Quick action buttons
                document.getElementById('change-password-btn').addEventListener('click', () => {
                    this.changePassword();
                });

                document.getElementById('export-data-btn').addEventListener('click', () => {
                    this.exportData();
                });
            }

            async updatePersonalInfo() {
                const data = {
                    name: document.getElementById('name').value,
                    phone: document.getElementById('phone').value
                };

                await this.updateProfile(data, 'Personal information updated successfully');
            }

            async updateRestaurantInfo() {
                const data = {
                    restaurant_name: document.getElementById('restaurant-name').value,
                    cuisine_type: document.getElementById('cuisine-type').value,
                    location: document.getElementById('location').value,
                    description: document.getElementById('description').value
                };

                await this.updateProfile(data, 'Restaurant information updated successfully');
            }

            async updateBrandVoice() {
                const data = {
                    brand_personality: document.getElementById('brand-personality').value,
                    content_tone: document.getElementById('content-tone').value,
                    specialties: document.getElementById('specialties').value,
                    target_audience: document.getElementById('target-audience').value
                };

                await this.updateProfile(data, 'Brand voice settings updated successfully');
            }

            async updateProfile(data, successMessage) {
                try {
                    const response = await this.authManager.apiRequest('/api/user/profile', {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) throw new Error('Failed to update profile');

                    this.showMessage(successMessage, 'success');

                } catch (error) {
                    console.error('Failed to update profile:', error);
                    this.showMessage('Failed to update profile', 'error');
                }
            }

            async updateLanguage(language) {
                await this.updateProfile({ preferred_language: language }, 'Language preference updated');
            }

            changePassword() {
                // This would typically open a modal or redirect to a password change page
                alert('Password change functionality would be implemented here');
            }

            async exportData() {
                try {
                    const response = await this.authManager.apiRequest('/api/user/export');
                    if (!response.ok) throw new Error('Failed to export data');

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'chefsocial-data-export.json';
                    a.click();
                    window.URL.revokeObjectURL(url);

                    this.showMessage('Data export initiated', 'success');

                } catch (error) {
                    console.error('Failed to export data:', error);
                    this.showMessage('Failed to export data', 'error');
                }
            }

            showMessage(message, type) {
                const container = document.getElementById('message-container');
                const messageEl = document.createElement('div');
                messageEl.className = `message message-${type}`;
                messageEl.textContent = message;
                
                container.appendChild(messageEl);
                
                setTimeout(() => {
                    messageEl.remove();
                }, 5000);
            }
        }

        // Initialize profile manager when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ProfileManager();
        });
    </script>

    <style>
        .form-input {
            resize: vertical;
        }

        .message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .message-success {
            background: #dcfce7;
            color: var(--green-500);
            border: 1px solid #bbf7d0;
        }

        .message-error {
            background: #fef2f2;
            color: var(--red-500);
            border: 1px solid #fecaca;
        }
    </style>
</body>
</html>